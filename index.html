<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
    <title>Sky Music</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>
<link rel="stylesheet" href="style.css" type="text/css">

<body>
    <div id="savedSongsDivWrapper" class="floatingDiv">
        <h3>Here are all your saved songs!</h3>
        <div id="savedSongsDiv" class="topSavedSongsDiv"></div>
        <div class = "bottomSavedSongsDiv">
            <button class="skyButton" onclick="importSongs()">Import songs</button>
            <button class="skyButton" onclick="downloadSongs()">Download songs</button>
            <input type=file style="display:none;" id="filePicker">
        </div>
    </div>
    <div class="menuDiv">
        <button class="skyButton" onclick="toggleSavedSongs()">Manage Recordings</button>
        <button class="skyButton" id="toggleRecordBtn" onclick="toggleRecord()"> Start/Stop recording</button>
        <button class="musicButton" id="toggleInstruments" onclick="toggleInstrumentList()"></button>
    </div>
    <div class="videoWrapper video">
        <div class="vsc-controller" data-vscid="jvm0gu2z7"></div>
        <video preload="auto" playsinline="" muted="" autoplay="" loop="" data-vscid="jvm0gu2z7">
            <source src="./AnimatedBG/skygame-banner.webm" type="video/webm;codecs=&quot;vp8, vorbis&quot;">
            <source src="./AnimatedBG/skygame-banner.ogv" type="video/ogv;codecs=&quot;ogv, ogg, vorbis &quot;">
            <source src="./AnimatedBG/skygame-banner.mp4" type="video/mp4;codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
        </video>
    </div>
    <div id=touch>
        <div class="Row1" id="row1"></div>
        <div class="Row2" id="row2"></div>
        <div class="Row3" id="row3"></div>
    </div>
    </div>
    <div id="instrumentsNew" class="instrumentsWrapper">
        <button type="button" id="pianoBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/piano.png);"/>
        <button type="button" id="harpBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/harp.png);"/>
    <!--<button type="button" id="hornBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/horn.png);"/>
        <button type="button" id="bassBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/bass.png);"/>
        <button type="button" id="drumBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/drum.png);"/> 
        <button type="button" id="xylophoneBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/xylophone.png);"/>
        <button type="button" id="guitarBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/guitar.png);"/>
        <button type="button" id="winterPiano" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/winterPiano.png);"/>
        <button type="button" id="fluteBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/flute.png);"/>
        <button type="button" id="banjoBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/banjoBtn.png);"/> 
        <button type="button" id="panfluteBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/panflute.png);"/>  
        <button type="button" id="bellBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/bell.png);"/>   
        TO REMOVE ONCE NEW INSTRUMENTS ARE ADDED
        -->
    </div>
</body>

</html>
<script type="text/javascript">
let instrumentsWrapper = document.getElementById("instrumentsNew")

function toggleInstrumentList() {
    if(instrumentsWrapper.style.display != "block") {
        instrumentsWrapper.style.display = "block"
    }else{
        instrumentsWrapper.style.display = "none"
    }
}

//--------------------------------------------------------------------------------------------------------//

function changeInstrument(button) {
    let chosenInstrument = button.id.replace("Btn", "")
    document.getElementById("toggleInstruments").style.backgroundImage = button.style.backgroundImage
    instrumentsWrapper.style.display = "none"
    changeInstrumentSound(chosenInstrument)
}

//--------------------------------------------------------------------------------------------------------//

//Loads the buttons with sounds
const db_url = 'https://dl.dropboxusercontent.com/s/';

let instrumentsNotes = {
    piano: ["xim7yvy80ou80bi/0.mp3?dl=0", "adh4qa72jiw7q4b/1.mp3?dl=0", "546fmppbpvr80rh/2.mp3?dl=0", "aaph2izhy89oljc/3.mp3?dl=0", "oia9cq7mmk7lsa0/4.mp3?dl=0", "4285w5uzn5um6ay/5.mp3?dl=0", "2o1nszo0ry2ttoi/6.mp3?dl=0", "cnhjr7ljph30ycz/7.mp3?dl=0", "lqo9zv4bm6h13x4/8.mp3?dl=0", "d0brnsgqorwo67i/9.mp3?dl=0", "jq9dl35enpn4hgc/10.mp3?dl=0", "a07cku2ns81oiw2/11.mp3?dl=0", "c1gj4cn9ksctvhz/12.mp3?dl=0", "w1hhusqautlwz5w/13.mp3?dl=0", "u94o8hu4i05b0to/14.mp3?dl=0"],
    harp: ["r6quat6w0v5rvh3/0.mp3?dl=0", "uhket9niicm5gm5/1.mp3?dl=0", "rjae3a7dr9m7ork/2.mp3?dl=0", "l9a184zo84d9ioi/3.mp3?dl=0", "3n05r4n7z3isoza/4.mp3?dl=0", "mwzqyyn9umas9t6/5.mp3?dl=0", "537bb87nwgi8p1a/6.mp3?dl=0", "6bwuwlvqsjx9l3q/7.mp3?dl=0", "quhgcrlft201bhk/8.mp3?dl=0", "er3d7cmixvat8jd/9.mp3?dl=0", "r3g5p2k0bglf2kv/10.mp3?dl=0", "qngf2z1gpe4ay6q/11.mp3?dl=0", "kej92xl4qmew8nc/12.mp3?dl=0", "o8ybz932wztida4/13.mp3?dl=0", "zt8s8tblh8rw7nh/14.mp3?dl=0"],
}
//Changes sounds when instrument is selected
function changeInstrumentSound(instrument) {
    console.log(instrument)
    localStorage.setItem('instrument', instrument);
    location.reload();
}
//Checks which instrument has been stored in localstorage, if none place piano
let storedInstrument = "piano"
if(localStorage.getItem("instrument")) {
    storedInstrument = localStorage.getItem("instrument")
    document.getElementById("toggleInstruments").style.backgroundImage = document.getElementById(storedInstrument + "Btn").style.backgroundImage
}else{
    localStorage.setItem("instrument", "piano")
}

//Changes url of the instrument using the stored value in localStorage
var urls = instrumentsNotes[storedInstrument];

//--------------------------------------------------------------------------------------------------------//

function preload(urls) {
    const requests = urls.map(url => fetch(db_url + url)
        .then(r => r.arrayBuffer()) // this time we request as ArrayBuffer
        .then(b => {
            return new Promise((resolve, reject) => {
                a_ctx.decodeAudioData(b, resolve, reject)
            });
        })
    );
    return Promise.all(requests);
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//BUTTONS
const a_ctx = new(window.AudioContext || window.webkitAudioContext)();
var buttonImages = ["diamondCircle", "Diamond", "Circle", "Diamond", "Circle", "Circle", "Diamond", "diamondCircle", "Diamond", "Circle", "Circle", "Diamond", "Circle", "Diamond", "diamondCircle", ]
let usesTouch = false;
let numOfKeysLeft = 15
let newRowBreak = [6, 11]
preload(urls)
    .then(audioBuffers => {
        if(storedInstrument == "bell") numOfKeysLeft = 8, newRowBreak = [5, 9], buttonImages = ["circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "circle", "Diamond", "circle"]
        var j = 1
        audioBuffers.forEach((buf, i) => {
            //Creates button and sets the buttons properties .
            usesTouch = false;
            const btn = document.createElement('div');
            let background = "./KeyImages/" + buttonImages[i] + ".png"
            btn.innerHTML = "<div class='btnBg'></div><img class='btnImg' src='" + background + "'/>"
            btn.id = "Key" + i++
            if(i == newRowBreak[0]) j = 2
            if(i == newRowBreak[1]) j = 3
            document.getElementById("row" + j).appendChild(btn)
            numOfKeysLeft--
            if(numOfKeysLeft < 0) { //if there are no more keys to add, it makes the other buttons invisible
                btn.style.display = "none";
                return; // to make the buttons not clickable
            }
            btn.addEventListener("click", function() {
                if(!usesTouch) buttonPressEvent(this)
            })
            btn.addEventListener("touchstart", function() {
                usesTouch = true;
                buttonPressEvent(this)
            })
            
            function buttonPressEvent(btn) {
                let btnBg = btn.firstChild
                let btnImg = btn.childNodes[1]
                let bgColor = btnBg.style.backgroundColor
                if(bgColor != "rgba(22, 22, 22, 0.65)" && bgColor != "rgba(60, 60, 60, 0.65)" && bgColor !="") {
                    $(btn).children(":first").stop()
                    btnBg.style.borderColor = "transparent"
                    practice([])
                }
                const source = a_ctx.createBufferSource();
                source.buffer = buf;
                source.connect(a_ctx.destination);
                source.start(0);
                reply_click(btn.id)
                recordSong(btn.id)
                btnImg.classList.toggle("keyTurn")
                btn.classList.toggle("keyScale")
                resetKeyClass(btn)
            }
        });
    });

//--------------------------------------------------------------------------------------------------------//

function resetKeyClass(element) {
    setTimeout(() => {
        element.childNodes[1].classList.remove("keyTurn");
        element.classList.remove("keyScale");
    }, 250);
    
}


//--------------------------------------------------------------------------------------------------------//

//Changes the brightness when button clicked.
function reply_click(clicked_id) {
    let i;
    let element;
    i = clicked_id;
    a = i.replace(/Key/, '')
    element = document.getElementById(i);
    element.style.filter = "brightness(130%)"
    let btnBg = element.firstChild
    btnBg.style.backgroundColor = "rgba(60, 60, 60, 0.65)"
    timer(element, a);
}

//--------------------------------------------------------------------------------------------------------//

//resets the color of the button
function timer(elem) {
    setTimeout(function() {
        elem.style.filter = 'brightness(100%)';
        let btnBg = elem.firstChild
        btnBg.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }, 200);
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//FILE IMPORT/EXPORT
var filePicker = document.getElementById("filePicker")

function importSongs() {
    filePicker.addEventListener("change", function() { //once file is picked it reads the content
    try{
        var fr = new FileReader();
        fr.onload = function() {
            inputSongs = JSON.parse(fr.result)
            for (var i = 0; i < inputSongs.length; i++) {
                if(document.getElementById("Song-" + inputSongs[i].name) == null) { //if there is an element with this id, it means that the song with that name already exists
                    saveSong(inputSongs[i].name, inputSongs[i].songNotes, false)
                }else{
                    console.log("there is already a song with the name: " + inputSongs[i].name)
                }
            }
        }
        fr.readAsText(this.files[0]);
        }catch(e){
            alert("Error importing the song!")
        }
    })
    filePicker.click()
}

//--------------------------------------------------------------------------------------------------------//

function downloadSongs() {
    var songs = localStorage.getItem("savedSongs") //gets the songs saved in localStorage and downloads them as JSON
    if(songs != null) { //if there were some songs saved
        songs = JSON.parse(songs)
        if(songs.length != 0) { //if there were some songs saved
            downloadJSON(songs, "mySongs.json")
        }
    }
}

//--------------------------------------------------------------------------------------------------------//

function downloadJSON(inArray, fileName) {
    var json = JSON.stringify(inArray);
    
    //Convert JSON string to BLOB.
    json = [json];
    var blob1 = new Blob(json, {
        type: "text/plain;charset=utf-8"
    });
    
    //Check the Browser.
    //Honestly idk lol, i copied this and it works -Specy
    var isIE = false || !!document.documentMode;
    if(isIE) {
        window.navigator.msSaveBlob(blob1, fileName);
    }else{
        var url = window.URL || window.webkitURL;
        link = url.createObjectURL(blob1);
        var a = document.createElement("a");
        a.download = fileName;
        a.href = link;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//RECORDING MUSIC
let isRecordToggled = false;
var startTime;
var animationInterval;

function toggleRecord() {
    if(isRecordToggled) { //if the recording is toggled already then it means it was listening, now stops listening and saves the song
        if(songArray.length != 0) {
            var text = "Please enter the song name:"
            while (true) {
                var promtText = prompt(text, "Jingle bells"); //asks for the song name
                if(promtText == null || promtText == "") {
                    console.log("User ignored the save")
                    break;
                }else{
                    if(document.getElementById("Song-" + promtText) == null) { //if there is already a song with that name, ask to rename it
                        saveSong(promtText, songArray, false)
                        break;
                    }
                    text = "There is already a song with name: " + promtText + " chose another!"
                }
            }
        }
        songArray = []
        toggleRecordBtn.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }else{
        toggleRecordBtn.style.backgroundColor = "rgba(235, 0, 27, 0.8)"
    }
    isRecordToggled = !isRecordToggled
    startTime = new Date().getTime()
}
var savedSongsDiv = document.getElementById("savedSongsDiv")
var savedSongsDivWrapper = document.getElementById("savedSongsDivWrapper")
document.getElementById("touch").addEventListener("click", function() {
    savedSongsDivWrapper.style.display = "none"
    instrumentsWrapper.style.display = "none"
})

function toggleSavedSongs() {
    if(savedSongsDivWrapper.style.display != "block") {
        savedSongsDivWrapper.style.display = "block"
    }else{
        savedSongsDivWrapper.style.display = "none"
    }
}

//--------------------------------------------------------------------------------------------------------//

//this loads the stored songs in local storage and adds them to the recorded songs, the "true" in saveSong() means that it doesn't have to add 
//the song to the favourites because it is already saved
preLoadSongs = localStorage.getItem("savedSongs")
if(preLoadSongs != null) {
    preLoadSongs = JSON.parse(preLoadSongs)
    for (var i = 0; i < preLoadSongs.length; i++) {
        saveSong(preLoadSongs[i].name, preLoadSongs[i].songNotes, true)
    }
}

//--------------------------------------------------------------------------------------------------------//

function saveSong(songName, song, isPreloading) { //the name of the song, the array containing the key press and time stamp, if it has to be ignored or not for the save option
    var songObj = {
        name: songName,
        songNotes: song
    }
    if(!isPreloading) { //doesnt save if it is preloading
        var songStorage = localStorage.getItem("savedSongs")
        if(songStorage != null) {
            songStorage = JSON.parse(songStorage)
            songStorage.push(songObj)
            localStorage.setItem("savedSongs", JSON.stringify(songStorage))
        }else{
            songStorage = [songObj]
            localStorage.setItem("savedSongs", JSON.stringify(songStorage))
        }
    }
    //--------------------------------// Dinamically create the button to play the song
    var songContainer = document.createElement("div")
    var songButton = document.createElement("button")
    songButton.setAttribute("songName", songName)
    songButton.addEventListener("click", function() {
        savedSongsDivWrapper.style.display = "none"
        var storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        resetButtons()
        playSong(JSON.parse(songText.innerHTML))
    })
    songButton.innerHTML = songName
    songButton.className = "skyButton"
    songButton.style.width = "calc(100% - 120px - 4em)"
    //--------------------------------// This holds the text of the array of the song 
    var songText = document.createElement("div")
    songText.style.display = "none"
    songText.id = "Song-" + songName
    songText.innerHTML = JSON.stringify(song)
    songContainer.appendChild(songButton)
    songContainer.appendChild(songText)
    console.log("song added!")
    savedSongsDiv.appendChild(songContainer)
    //--------------------------------// button to delete the song from the saved and to delete it from the menu
    var deleteButton = document.createElement("button")
    deleteButton.innerHTML = "âŒ"
    deleteButton.className = "skyButton"
    deleteButton.style.width = "40px"
    deleteButton.setAttribute("songName", songName)
    deleteButton.addEventListener("click", function() {
        if(confirm("Delete song: " + this.getAttribute("songName") + "?")) {
            this.parentNode.parentNode.removeChild(this.parentNode)
            var savedSongs = localStorage.getItem("savedSongs")
            if(savedSongs != null) {
                savedSongs = JSON.parse(savedSongs)
                for (var i = 0; i < savedSongs.length; i++) { //reads trough all the elements of the localStorage and deletes the index of this song
                    if(savedSongs[i].name == this.getAttribute("songName")) {
                        savedSongs.splice(i, 1)
                        break;
                    }
                }
                localStorage.setItem("savedSongs", JSON.stringify(savedSongs))
            }
        }
    })
    //--------------------------------// Button to play this song in practice mode
    var trainSong = document.createElement("button")
    trainSong.innerHTML = "ðŸŽ¯"
    trainSong.className = "skyButton"
    trainSong.style.width = "40px"
    trainSong.setAttribute("songName", songName)
    trainSong.addEventListener("click", function() {
        savedSongsDivWrapper.style.display = "none"
        var storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        practice(JSON.parse(songText.innerHTML))
    })
    //--------------------------------// Button to share this song
    var shareButton = document.createElement("button")
    shareButton.innerHTML = "<img src='icons/share.png' alt='share' width='20px' style='vertical-align: bottom'/>"
    shareButton.style.color = "lightgreen"
    shareButton.style.fontWeight = "bold"
    shareButton.className = "skyButton"
    shareButton.style.width = "40px"
    shareButton.setAttribute("songName", songName)
    shareButton.addEventListener("click", function() {
        var storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        var songObj = {
            name: storedSongName,
            songNotes: JSON.parse(songText.innerHTML)
        }
        var array = []
        array.push(songObj)
        downloadJSON(array, storedSongName + ".json")
    })
    songContainer.appendChild(trainSong)
    songContainer.appendChild(deleteButton)
    songContainer.appendChild(shareButton)
}

//--------------------------------------------------------------------------------------------------------//

async function playSong(song) {
    console.dir(song)
    var delayTime = 0;
    var previousTime = 0;
    usesTouch = false;
    for (var i = 0; i < song.length; i++) {
        delayTime = song[i].time - previousTime //how much time has to pass from one note to the other
        previousTime = song[i].time //the time from the start of the previous note, to be later calculated to get the delayTime
        await delay(delayTime);
        document.getElementById(song[i].key).click()
    }
}


//--------------------------------------------------------------------------------------------------------//

function resetButtons() {
    for (var i = 0; i < 14; i++) {
        let btnBg = document.getElementById("Key" + i).firstChild
        btnBg.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }
}

//--------------------------------------------------------------------------------------------------------//

//Function to practice a song
let songToPractice = []
let keysToPress = []
let threshold = 50
let keysToWait = 1;
let oldTime = 0;
let betweenKeysTimes = []
let timeToWait = 0;
let nextKeysToPress = []
betweenKeysTimes.push(0) //offsets the first key
function practice(inSong) {
    if(inSong.length != 0) { //If there is a song to be added, if there isn't it means that it comes from a ping from the button
        //RESET OF VALUES AND SETTING UP THE SONG
        betweenKeysTimes = []
        betweenKeysTimes.push(0)
        timeToWait = 0;
        songToPractice = inSong
        console.log(songToPractice)
        keysToWait = 1
        justReset = true;
        resetButtons()
        for(var i=1; i<songToPractice.length;i++){ //stores the time between keys
            betweenKeysTimes.push(songToPractice[i].time - songToPractice[i-1].time)
        }
    }
    if(songToPractice.length == 0) return;
    keysToWait--   
    if(keysToWait == 0) {
        keysToPress = []
        nextKeysToPress = []
        for (var i = 0; i < songToPractice.length; i++) {
            if((songToPractice[i].time - songToPractice[0].time) < threshold) { //if the time between the next keys is lower than the threshold then it appends to the keys to be played
                keysToPress.push(songToPractice[i])
            }
        }
        for(var i = keysToPress.length; i<songToPractice.length;i++) {
            if((songToPractice[i].time - songToPractice[keysToPress.length].time) < threshold) {
                nextKeysToPress.push(songToPractice[i])
            }
        }
        console.log(nextKeysToPress)
        setTimeout(() => { //delays from the ping so that it lets the key change it's color 
            
            setTimeout(() => {
                for(var i = 0; i < nextKeysToPress.length;i++){
                     $("#"+nextKeysToPress[i].key).children(":first").animate({"border-color": '#1BB8E8'}, 220);
                }                 
            }, timeToWait-220);
            let willBeEmpty = songToPractice.length - keysToPress.length
            betweenKeysTimes.splice(0,keysToPress.length) //removes the times of each button since they arent used
            for (var i = 0; i < keysToPress.length; i++) { //it changes the color to the reddish one and removes the keys to be pressed from the array
                $("#" + keysToPress[i].key).children(":first").cssborderColor = "transparent"
                $("#" + keysToPress[i].key).children(":first").css("border-color","transparent").animate({backgroundColor: 'rgba(235, 0, 27, 0.7)'}, timeToWait);
                songToPractice.splice(0, 1)   
            }
            timeToWait=betweenKeysTimes[0] -220 //gets the first time of the array, that one is the time for the next one.
        }, 220);

        keysToWait = keysToPress.length //those are the keys presses to do before searching for the next key combination
    }
}
//--------------------------------------------------------------------------------------------------------//

//delay function
const delay = ms => new Promise(res => setTimeout(res, ms));

//--------------------------------------------------------------------------------------------------------//


let songArray = []
//Each time a button is pressed, if the record is toggled, it adds a timestamp and what button is pressed
function recordSong(pressedKey) {
    if(isRecordToggled) {
        pressTime = new Date().getTime()
        var keyPressObject = {
            time: pressTime - startTime,
            key: pressedKey
        }
        songArray.push(keyPressObject)
    }
}
</script>