<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
    <title>Sky Music</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>
<link rel="stylesheet" href="style.css" type="text/css">

<body>
    <div class="secondPage" id="secondPage">

        <div id="login">
            <div id="loginContainer">
              <h1>Log in to Sky Music!</h1>
              <div>

                <label class="formLabel"><b>EMAIL</b></label>
                <input type="text" placeholder="Enter email" class="formInput" id="emailLogin">
      
                <label class="formLabel"><b>PASSWORD</b></label>
                <input type="password" placeholder="Enter Password" class="formInput" id="passwordLogin">
                <button onclick = "login(false)">LOGIN</button>
      
                <span onclick="toggleRegister()"><a href="#">Create account</a></span><span id="forgotLink" onclick="toggleReset()"><a href="#">Forgot password?</a></span>
      
              </div> 
            </div>
          </div>
          <div id="register">
            <div id="registerContainer">
                <h1>Register to Sky Music!</h1>
                <div>

                  <label class="formLabel"><b>EMAIL</b></label>
                  <input type="text" placeholder="Enter Email" class="formInput" id="emailRegister">
        
                  <label class="formLabel"><b>PASSWORD</b></label>
                  <input type="password" placeholder="Enter Password" class="formInput" id="passwordRegister">

                  <label class="formLabel"><b>CONFIRM PASSWORD</b></label>
                  <input type="password" placeholder="Enter again Password" class="formInput" id="passwordRegister2">
        
                  <button onclick = "register()">REGISTER</button>
                  <span onclick="resetPages()"><a href="#">Go back</a></span>
                </div> 
              </div>
          </div>
          <div id="confirmRegistration">
            <div id="confirmContainer">
                <h1>Register to Sky Music!</h1>
                <div>       
                  <label id="confirmationLabel" class="formLabel"><b>CODE</b></label>
                  <input type="password" placeholder="Enter code" class="formInput" id="codeConfirmation">
        
                  <button onclick = "confirmEmail()">CONFIRM</button>
                  <span onclick="resetPages()"><a href="#">Go back</a></span>
                </div> 
              </div>
          </div>
          <div id="resetPassword">
            <div id="resetContainer">
                <h1>Reset a Forgotten Password!</h1>
                <div>

                  <label class="formLabel"><b>EMAIL</b></label>
                  <input type="text" placeholder="Enter Email" class="formInput" id="emailReset">
                  <button onclick = "resetPassword()">SUBMIT</button>
                  <span onclick="resetPages()"><a href="#">Go back</a></span>
                </div> 
              </div>
          </div>
    </div>


    <div id="savedSongsDivWrapper" class="floatingDiv">

        <div class="tab">
            <button id="localStoredBtn" class="tablinks active" onclick="openSonglist(event, 'localSongs')">Local songs</button>
            <button class="tablinks" onclick="openSonglist(event, 'dbSongs')">DB songs</button>
          </div>
        <!--Local Songs-->
          <div id="localSongs" class="tabcontent">
            <h3>Here are all your locally stored songs!</h3>
            <div id="savedSongsDiv" class="topSavedSongsDiv"></div>
            <div class = "bottomSavedSongsDiv">
                <button class="skyButton" onclick="importSongs()">Import songs</button>
                <button class="skyButton" onclick="downloadSongs()">Download songs</button>
                <input type=file style="display:none;" id="filePicker">
            </div>
          </div>
            <!--Database Songs-->
          <div id="dbSongs" class="tabcontent">
            <h3>Here are all of your saved songs from our database!</h3>
            <div id="dbSongsDiv" class="topSavedSongsDiv"></div>
            <div class = "bottomSavedSongsDiv">
                <button class="skyButton" onclick="syncDB()">Load songs from database</button>
                <button class="skyButton" onclick="storeSongsLocally()">Store songs locally</button>
            </div>
          </div>
    </div>


    <button id="menu" style="display: block;"onclick="showMenu()"></button>
    <div id="icon-bar">
        <button class="skyButton_2" onclick='resetPages(),showMenu(),document.getElementById("login").style.display = "none"'><p class="texts">Main page</p></button>
        <button class="skyButton_2" onclick="showMenu()"><p class="texts">Close menu</p></button>
        <button class="skyButton_2" onclick="toggleLogin()"><p class="texts">Login</p></button>
        <button class="skyButton_2" onclick="toggleSettings()"><p class="texts">Settings</p></button>
    </div>
    <div class="menuDiv">
        <button class="skyButton" onclick="toggleSavedSongs()">Manage Recordings</button>
        <button class="skyButton" id="toggleRecordBtn" onclick="toggleRecord()"> Start/Stop recording</button>
        <button class="musicButton" id="toggleInstruments" onclick="toggleInstrumentList()"></button>
    </div>
    <div class="videoWrapper video">
        <div class="vsc-controller" data-vscid="jvm0gu2z7"></div>
        <video preload="auto" playsinline="" muted="" autoplay="" loop="" data-vscid="jvm0gu2z7">
            <source src="./AnimatedBG/skygame-banner.webm" type="video/webm;codecs=&quot;vp8, vorbis&quot;">
            <source src="./AnimatedBG/skygame-banner.ogv" type="video/ogv;codecs=&quot;ogv, ogg, vorbis &quot;">
            <source src="./AnimatedBG/skygame-banner.mp4" type="video/mp4;codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
        </video>
    </div>
    <div id=touch>
        <div class="Row1" id="row1"></div>
        <div class="Row2" id="row2"></div>
        <div class="Row3" id="row3"></div>
    </div>
    </div>
    <div id="instrumentsNew" class="instrumentsWrapper">
        <button type="button" id="pianoBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/piano.png);"/>
        <button type="button" id="harpBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/harp.png);"/>
        <button type="button" id="bellBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/bell.png);"/> 
        <button type="button" id="guitarBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/guitar.png);"/>
        <button type="button" id="fluteBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/flute.png);"/>
        <button type="button" id="xylophoneBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/xylophone.png);"/>
        <button type="button" id="drumBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/drum.png);"/> 
    <!--<button type="button" id="hornBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/horn.png);"/>
        <button type="button" id="xylophoneBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/xylophone.png);"/>
        <button type="button" id="bassBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/bass.png);"/>
        <button type="button" id="winterPiano" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/winterPiano.png);"/>
        <button type="button" id="banjoBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/banjoBtn.png);"/> 
        <button type="button" id="panfluteBtn" class="instrumentButton"  onclick="changeInstrument(this)" style="background-image: url(./images/panflute.png);"/>  
        TO REMOVE ONCE NEW INSTRUMENTS ARE ADDED
        -->
    </div>
    <div id="floatingMessage" class="floatingMessage"> placeholder text </div>
</body>

</html>
<script type="text/javascript">

    let websiteURL = "https://sky-music.herokuapp.com/"
    //  websiteURL = "http://localhost:8080/"


//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//
//LOGIN AND ACCOUNT

function toggleReset(){
    resetPages()
    document.getElementById("resetPassword").style.display = "block"
}

//--------------------------------------------------------------------------------------------------------//

function toggleLogin(){
    resetPages()
    document.getElementById("login").style.display = "block"
    showMenu()
}

//--------------------------------------------------------------------------------------------------------//

function toggleRegister(){
    resetPages()
    document.getElementById("register").style.display = "block"
}

//--------------------------------------------------------------------------------------------------------//

function toggleSettings(){
    showMessage("Incoming!",1)
}

function resetPages(){
    document.getElementById("secondPage").style.display = "block"
    document.getElementById("login").style.display = "none"
    document.getElementById("resetPassword").style.display = "none"
    document.getElementById("register").style.display = "none"
    document.getElementById("confirmRegistration").style.display = "none"
}
//--------------------------------------------------------------------------------------------------------//

function resetPassword(){
    let mail = document.getElementById("emailReset").value
    if(mail.trim() == "" || !/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)){
        showMessage("please put an email",2)
        return;
    }
    let credentials = {
        email: mail
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"resetPassword");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            if(response == "true"){
                showMessage("success! please check you email.",1)
            }else{
                showMessage(response,0)
            }
        };
        request.onerror = function(e) {
            showMessage("Error trying to LogIn",0)
        };
        request.send(JSON.stringify(credentials))
}

//--------------------------------------------------------------------------------------------------------//

var registrationCredentials;
console.log("add input verification like minimum password length, no special characters allowed in nickname etc")
function register(){
    let mail = document.getElementById("emailRegister").value.toLowerCase()
    let psw = document.getElementById("passwordRegister").value
    let psw2 = document.getElementById("passwordRegister2").value
    if(psw == "" || mail == ""){
        showMessage("please put email,username and password",2)
        return;
    }

    if(!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)){
        showMessage("You put an invalid email!",2)
        return;
    }
    if(psw != psw2){
        showMessage("The passwords don't match!",2)
        document.getElementById("passwordRegister2").value = ""
        document.getElementById("passwordRegister").value = ""
        return;
    }
    let credentials = {
        password: psw,
        email: mail
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"createAccount");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            registrationCredentials = credentials
            if(response == "true"){
                setTimeout(() => {
                    document.getElementById("confirmationLabel").innerHTML = "CODE FOR: "+credentials.email
                    document.getElementById("confirmRegistration").style.display = "block"
                    document.getElementById("register").style.display = "none"
                }, 500);
                return;
            }
            showMessage(response,1)
        };
        request.onerror = function(e) {
            showMessage("Error creating the account!",1)
        };
        request.send(JSON.stringify(credentials))
}

//--------------------------------------------------------------------------------------------------------//

var isAuthenticated = false
preloadCredentials = localStorage.getItem("credentials")
if(preloadCredentials != null){
    preloadCredentials = JSON.parse(preloadCredentials)
    document.getElementById("emailLogin").value = preloadCredentials.email
    document.getElementById("passwordLogin").value = preloadCredentials.password
    login(true)
}

//--------------------------------------------------------------------------------------------------------//

function login(ignoreMessage){
    let mail = document.getElementById("emailLogin").value
    let psw = document.getElementById("passwordLogin").value
    if(mail == "" || psw == ""){
        showMessage("please put username and password",2)
        return;
    }
    if(psw.length < 6){
        showMessage("Password must be at least 6 characters long",0)
        return;
    }
    let credentials = {
        password: psw,
        email: mail
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"login");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            if(response == "true"){
                isAuthenticated = true
                globalCredentials = credentials
                secondPage.style.display = "none"
                localStorage.setItem("credentials",JSON.stringify(credentials))
                if(!ignoreMessage) showMessage("Logged in!",1)

            }else{
                if(!ignoreMessage) showMessage(response,0)
            }
        };
        request.onerror = function(e) {
            if(!ignoreMessage) showMessage("Error trying to LogIn",0)
        };
        request.send(JSON.stringify(credentials))
}

//--------------------------------------------------------------------------------------------------------//
var globalCredentials = {
    password: "",
    email: ""
}
function storeSongsLocally(){
    if(!isAuthenticated){
        showMessage("You are not logged in",2)
        return;
    }
    if(dbSongs.length == 0){
        showMessage("There are no songs saved in the database or you haven't loaded them",2)
        return;
    }else{
        for(let i=0;i<dbSongs.length;i++){
            saveSong(dbSongs[i].name, dbSongs[i].songNotes, 1)
        }
    }
}

//--------------------------------------------------------------------------------------------------------//

var dbSongs = []
function syncDB(){
    credentials = globalCredentials;
    if(!isAuthenticated){
        showMessage("You are not logged in!",2)
        return;
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"getSongs");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            try{
                var songsFromDB = JSON.parse(response)
            }catch{
                showMessage(response,0)
                return;
            }
            dbSongs = songsFromDB
            if(songsFromDB.length == 0) showMessage("No songs saved in the database!")
            for(var i = 0 ; i<songsFromDB.length;i++){
                saveSong(songsFromDB[i].name, songsFromDB[i].songNotes, 2)
            }
            console.log(songsFromDB)
        };
        request.onerror = function(e) {
            alert("Error trying to get songs!")
        };
        request.send(JSON.stringify(credentials))
}

//--------------------------------------------------------------------------------------------------------//

function deleteFromDB(credentials,song){
    if(!isAuthenticated){
        showMessage("You are not logged in!",2)
        return;
    }
    var objToSend = {
        email: credentials.email,
        password: credentials.password,
        songName: song
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"deleteSong");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            console.log(response)
        };
        request.onerror = function(e) {
            alert("Error trying to delete song!")
        };
        request.send(JSON.stringify(objToSend))
}

//--------------------------------------------------------------------------------------------------------//

function saveSongsToDB(credentials,songsToSend){
    if(!isAuthenticated){
        showMessage("You are not logged in!",2)
        return;
    }
    var objToSend = {
        email: credentials.email,
        password: credentials.password,
        song: songsToSend
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"saveSongs");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            console.log(response)
        };
        request.onerror = function(e) {
            alert("Error trying to save songs!")
        };
        request.send(JSON.stringify(objToSend))
}

//--------------------------------------------------------------------------------------------------------//

function resetForms(){
    for(var i=0; i<inputs.length;i++){
        inputs.value = ""
    }
}

//--------------------------------------------------------------------------------------------------------//

function confirmEmail(){
    var code = document.getElementById("codeConfirmation").value
    document.getElementById("confirmRegistration").style.display = "block"
    if(code.length != 6){
        alert("You put an invalid code!")
        return;
    }
    let credentials = {
        code: code,
        email: registrationCredentials.email
    }
    let request = new XMLHttpRequest();
    request.open("POST", websiteURL+"verifyAccount");
    request.setRequestHeader("Content-Type", "application/json; charset=utf-8")
    request.onload = (res) => {
            response = res.target.response;
            if(response == "true"){
                alert("Account verified, refreshing in 2 seconds")
                location.reload()
                return;
            }
            console.log(response)
        };
        request.onerror = function(e) {
            alert("Error verifying the account!")
        };
        request.send(JSON.stringify(credentials))
}
//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//LOADING WEBSITE
inputs = document.getElementsByTagName("input")
var isTyping = false
for(var i=0; i<inputs.length;i++){
    inputs[i].addEventListener("focusin",function(){
        isTyping = true
    })
    inputs[i].addEventListener("focusout",function(){
        isTyping = false
    })
}

//--------------------------------------------------------------------------------------------------------//

let objKeys = {
    "e":"Key0",
    "r":"Key1",
    "t":"Key2",
    "y":"Key3",
    "u":"Key4",
    "d":"Key5",
    "f":"Key6",
    "g":"Key7",
    "h":"Key8",
    "j":"Key9",
    "c":"Key10",
    "v":"Key11",
    "b":"Key12",
    "n":"Key13",
    "m":"Key14"
}   
document.onkeypress = function(evt) {
    evt = evt || window.event
    var charCode = evt.keyCode || evt.which
    var charStr = String.fromCharCode(charCode)
    if(objKeys[charStr] != null && !isTyping) document.getElementById(objKeys[charStr]).click()
};
//--------------------------------------------------------------------------------------------------------//

let instrumentsWrapper = document.getElementById("instrumentsNew")

function toggleInstrumentList() {
    if(instrumentsWrapper.style.display != "block") {
        instrumentsWrapper.style.display = "block"
    }else{
        instrumentsWrapper.style.display = "none"
    }
}

//--------------------------------------------------------------------------------------------------------//

function changeInstrument(button) {
    let chosenInstrument = button.id.replace("Btn", "")
    document.getElementById("toggleInstruments").style.backgroundImage = button.style.backgroundImage
    instrumentsWrapper.style.display = "none"
    changeInstrumentSound(chosenInstrument)
}

//--------------------------------------------------------------------------------------------------------//

//Loads the buttons with sounds
const db_url = './Sounds/'
let instrumentsNotes = {
    piano: ["Piano/0.mp3", "Piano/1.mp3", "Piano/2.mp3", "Piano/3.mp3", "Piano/4.mp3", "Piano/5.mp3", "Piano/6.mp3", "Piano/7.mp3", "Piano/8.mp3", "Piano/9.mp3", "Piano/10.mp3", "Piano/11.mp3", "Piano/12.mp3", "Piano/13.mp3", "Piano/14.mp3"],
    harp: ["Harp/0.mp3", "Harp/1.mp3", "Harp/2.mp3", "Harp/3.mp3", "Harp/4.mp3", "Harp/5.mp3", "Harp/6.mp3", "Harp/7.mp3", "Harp/8.mp3", "Harp/9.mp3", "Harp/10.mp3", "Harp/11.mp3", "Harp/12.mp3", "Harp/13.mp3", "Harp/14.mp3"],
    bell: ["Bells/0.mp3","Bells/1.mp3","Bells/2.mp3","Bells/3.mp3","Bells/4.mp3","Bells/5.mp3","Bells/6.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3","Bells/7.mp3"],
    guitar: ["Guitar/0.mp3", "Guitar/1.mp3", "Guitar/2.mp3", "Guitar/3.mp3", "Guitar/4.mp3", "Guitar/5.mp3", "Guitar/6.mp3", "Guitar/7.mp3", "Guitar/8.mp3", "Guitar/9.mp3", "Guitar/10.mp3", "Guitar/11.mp3", "Guitar/12.mp3", "Guitar/13.mp3", "Guitar/14.mp3"],
    flute: ["Flute/0.mp3", "Flute/1.mp3", "Flute/2.mp3", "Flute/3.mp3", "Flute/4.mp3", "Flute/5.mp3", "Flute/6.mp3", "Flute/7.mp3", "Flute/8.mp3", "Flute/9.mp3", "Flute/10.mp3", "Flute/11.mp3", "Flute/12.mp3", "Flute/13.mp3", "Flute/14.mp3"],
    xylophone: ["Xylophone/0.mp3", "Xylophone/1.mp3", "Xylophone/2.mp3", "Xylophone/3.mp3", "Xylophone/4.mp3", "Xylophone/5.mp3", "Xylophone/6.mp3", "Xylophone/7.mp3", "Xylophone/8.mp3", "Xylophone/9.mp3", "Xylophone/10.mp3", "Xylophone/11.mp3", "Xylophone/12.mp3", "Xylophone/13.mp3", "Xylophone/14.mp3"],
    drum: ["Drum/0.mp3", "Drum/1.mp3", "Drum/2.mp3", "Drum/3.mp3", "Drum/4.mp3", "Drum/5.mp3", "Drum/6.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3", "Drum/7.mp3"],

}
//Changes sounds when instrument is selected
function changeInstrumentSound(instrument) {
    console.log(instrument)
    localStorage.setItem('instrument', instrument)
    location.reload()
}
//Checks which instrument has been stored in localstorage, if none place piano
let storedInstrument = "piano"
if(localStorage.getItem("instrument")) {
    storedInstrument = localStorage.getItem("instrument")
    document.getElementById("toggleInstruments").style.backgroundImage = document.getElementById(storedInstrument + "Btn").style.backgroundImage
}else{
    localStorage.setItem("instrument", "piano")
}

//Changes url of the instrument using the stored value in localStorage
var urls = instrumentsNotes[storedInstrument]

//--------------------------------------------------------------------------------------------------------//

function preload(urls) {
    const requests = urls.map(url => fetch(db_url + url)
        .then(r => r.arrayBuffer()) // this time we request as ArrayBuffer
        .then(b => {
            return new Promise((resolve, reject) => {
                a_ctx.decodeAudioData(b, resolve, reject)
            })
        })
    )
    return Promise.all(requests)
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//BUTTONS
const a_ctx = new(window.AudioContext || window.webkitAudioContext)()
var buttonImages = ["diamondCircle", "Diamond", "Circle", "Diamond", "Circle", "Circle", "Diamond", "diamondCircle", "Diamond", "Circle", "Circle", "Diamond", "Circle", "Diamond", "diamondCircle", ]
let usesTouch = false
let numOfKeysLeft = 15
let newRowBreak = [6, 11]
preload(urls)
    .then(audioBuffers => {
        if(storedInstrument == "bell" || storedInstrument == "drum"){
            numOfKeysLeft = 8
            newRowBreak = [5, 9]
             buttonImages = ["Circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "Circle", "Diamond", "Circle"]
             objKeys = {
                "e":"Key0",
                "r":"Key1",
                "t":"Key2",
                "y":"Key3",
                "d":"Key4",
                "f":"Key5",
                "g":"Key6",
                "h":"Key7"
            }  
        } 
        var j = 1
        audioBuffers.forEach((buf, i) => {
            //Creates button and sets the buttons properties .
            usesTouch = false
            const btn = document.createElement('div')
            let background = "./KeyImages/" + buttonImages[i] + ".png"
            btn.innerHTML = "<div class='btnBg'></div><img class='btnImg' src='" + background + "'/>"
            btn.id = "Key" + i++
            if(i == newRowBreak[0]) j = 2
            if(i == newRowBreak[1]) j = 3
            document.getElementById("row" + j).appendChild(btn)
            numOfKeysLeft--
            if(numOfKeysLeft < 0) { //if there are no more keys to add, it makes the other buttons invisible
                btn.style.display = "none" // to make the buttons not clickable
                return
            }
            btn.addEventListener("click", function() {
                if(!usesTouch) buttonPressEvent(this)
                usesTouch = false
            })
            btn.addEventListener("touchstart", function() {
                usesTouch = true
                buttonPressEvent(this)
            })
            
            function buttonPressEvent(btn) {
                let btnBg = btn.firstChild
                let btnImg = btn.childNodes[1]
                let bgColor = btnBg.style.backgroundColor
                if(bgColor != "rgba(22, 22, 22, 0.65)" && bgColor != "rgba(60, 60, 60, 0.65)" && bgColor !="") {
                    $(btn).children(":first").stop()
                    btnBg.style.borderColor = "transparent"
                    practice([])
                }
                const source = a_ctx.createBufferSource()
                source.buffer = buf
                source.connect(a_ctx.destination)
                source.start(0)
                reply_click(btn.id)
                recordSong(btn.id)
                btnImg.classList.toggle("keyTurn")
                btn.classList.toggle("keyScale")
                resetKeyClass(btn)
            }
        })
    })

//--------------------------------------------------------------------------------------------------------//

function resetKeyClass(element) {
    setTimeout(() => {
        element.childNodes[1].classList.remove("keyTurn")
        element.classList.remove("keyScale")
    }, 250)
    
}


//--------------------------------------------------------------------------------------------------------//

//Changes the brightness when button clicked.
function reply_click(clicked_id) {
    let i
    let element
    i = clicked_id
    a = i.replace(/Key/, '')
    element = document.getElementById(i)
    element.style.filter = "brightness(130%)"
    let btnBg = element.firstChild
    btnBg.style.backgroundColor = "rgba(60, 60, 60, 0.65)"
    timer(element, a)
}

//--------------------------------------------------------------------------------------------------------//

//resets the color of the button
function timer(elem) {
    setTimeout(function() {
        elem.style.filter = 'brightness(100%)'
        let btnBg = elem.firstChild
        btnBg.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }, 200)
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//FILE IMPORT/EXPORT
let filePicker = document.getElementById("filePicker")

function importSongs() {
    filePicker.addEventListener("change", function() { //once file is picked it reads the content
        let fr = new FileReader()
        fr.onload = function() {
            inputSongs = JSON.parse(fr.result)
            for (let i = 0; i < inputSongs.length; i++) {
                let element = document.getElementById("Song-" + inputSongs[i].name)
                if(element == null) { //if there is an element with this id, it means that the song with that name already exists
                    saveSong(inputSongs[i].name, inputSongs[i].songNotes, 1)
                }else{
                    console.log("The song already exists :"+inputSongs[i].name)
                }
            }
        }
        fr.readAsText(this.files[0])
    })
    filePicker.click()
    $(filePicker).prop("value", "") //resets the path of the file picker so that the file can be picked twice in a row (not that it will be useful)
}

//--------------------------------------------------------------------------------------------------------//

function downloadSongs() {
    var songs = localStorage.getItem("savedSongs") //gets the songs saved in localStorage and downloads them as JSON
    if(songs != null) { //if there were some songs saved
        songs = JSON.parse(songs)
        if(songs.length != 0) { //if there were some songs saved
            downloadJSON(songs, "mySongs.json")
        }
    }
}

//--------------------------------------------------------------------------------------------------------//

function downloadJSON(inArray, fileName) {
    var json = JSON.stringify(inArray)
    
    //Convert JSON string to BLOB.
    json = [json]
    var blob1 = new Blob(json, {
        type: "text/plain;charset=utf-8"
    })
    
    //Check the Browser.
    //Honestly idk lol, i copied this and it works -Specy
    let isIE = false || !!document.documentMode
    if(isIE) {
        window.navigator.msSaveBlob(blob1, fileName)
    }else{
        let url = window.URL || window.webkitURL
        link = url.createObjectURL(blob1)
        let a = document.createElement("a")
        a.download = fileName
        a.href = link
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
    }
}

//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//

//MIDI CONTROL
    let isMidiAllowed = true;
    function checkMidiAccess(){
        try{
            if(navigator.requestMIDIAccess()){
                console.log("MIDI is supported")
            }else{
                console.log("MIDI not supported, it only works on google chrome")
            }
        }catch{
            console.log("MIDI not supported, it only works on google chrome")
        }
    }
    checkMidiAccess()
    try{
        navigator.requestMIDIAccess()
            .then(onMIDISuccess, onMIDIFailure);

    }catch{
        isMidiAllowed=false
        console.log("MIDI not supported, it only works on google chrome")
    }

//--------------------------------------------------------------------------------------------------------//

function onMIDIFailure() {
    isMidiAllowed=false
    console.log('Could not access your MIDI devices.');
}

//--------------------------------------------------------------------------------------------------------//

function onMIDISuccess(midiAccess) {
    for (var input of midiAccess.inputs.values()){
        input.onmidimessage = getMIDIMessage;
    }
}

//--------------------------------------------------------------------------------------------------------//

function getMIDIMessage(message) {
    var command = message.data[0];
    var note = message.data[1];
    usesTouch = false;
    if(command == 144 && note > 35 && note < 61){ //if the command is keyDown and the noteNumber are between 36 and 60
        switch(note){
            case 36: document.getElementById("Key0").click()
                break;
            case 38: document.getElementById("Key1").click()
                break;
            case 40: document.getElementById("Key2").click()
                break;
            case 41: document.getElementById("Key3").click()
                break;
            case 43: document.getElementById("Key4").click()
                break;
            case 45: document.getElementById("Key5").click()
                break;
            case 47: document.getElementById("Key6").click()
                break;
            case 48: document.getElementById("Key7").click()
                break;
            case 50: document.getElementById("Key8").click()
                break;
            case 52: document.getElementById("Key9").click()
                break;
            case 53: document.getElementById("Key10").click()
                break;
            case 55: document.getElementById("Key11").click()
                break;
            case 57: document.getElementById("Key12").click()
                break;
            case 59: document.getElementById("Key13").click()
                break;
            case 60: document.getElementById("Key14").click()
                break;
        }
    }
}
//--------------------------------------------------------------------------------------------------------//

//RECORDING MUSIC
let isRecordToggled = false
let startTime

function toggleRecord() {
    if(isRecordToggled) { //if the recording is toggled already then it means it was listening, now stops listening and saves the song
        if(songArray.length != 0) {
            let text = "Please enter the song name:"
            while (true) {
                var promtText = prompt(text, "Jingle bells") //asks for the song name
                if(promtText == null || promtText == "") {
                    console.log("User ignored the save")
                    break
                }else{
                    if(document.getElementById("Song-" + promtText) == null) { //if there is already a song with that name, ask to rename it
                        saveSong(promtText, songArray, 1)
                        break
                    }
                    text = "There is already a song with name: " + promtText + " chose another!"
                }
            }
        }
        songArray = []
        toggleRecordBtn.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }else{
        toggleRecordBtn.style.backgroundColor = "rgba(235, 0, 27, 0.8)"
    }
    isRecordToggled = !isRecordToggled
    startTime = new Date().getTime()
}

//--------------------------------------------------------------------------------------------------------//

let savedSongsDiv = document.getElementById("savedSongsDiv")
let savedSongsDivWrapper = document.getElementById("savedSongsDivWrapper")
let menu = document.getElementById("icon-bar");
let menuButton = document.getElementById("menu");
document.getElementById("touch").addEventListener("click", function() {
    floatingMessage.style.display = "none"
    savedSongsDivWrapper.style.display = "none"
    instrumentsWrapper.style.display = "none"
    menu.style.display = "none"
    console.log(menu)
    menuButton.style.display = "block"
})

//--------------------------------------------------------------------------------------------------------//

function toggleSavedSongs() {
    localStoredBtn.click()
    if(savedSongsDivWrapper.style.display != "block") {
        savedSongsDivWrapper.style.display = "block"
    }else{
        savedSongsDivWrapper.style.display = "none"
    }
}
//--------------------------------------------------------------------------------------------------------//

//TAB PAGE FOR SAVED SONGS
function openSonglist(evt, listType) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  evt.currentTarget.className += " active";
  document.getElementById(listType).style.display = "block";
  if(listType == "dbSongs" && dbSongs.length ==0) syncDB() //if it's the first time pressing the button
}

//--------------------------------------------------------------------------------------------------------//

//this loads the stored songs in local storage and adds them to the recorded songs, the "true" in saveSong() means that it doesn't have to add 
//the song to the favourites because it is already saved
preLoadSongs = localStorage.getItem("savedSongs")
if(preLoadSongs != null) {
    preLoadSongs = JSON.parse(preLoadSongs)
    for (let i = 0; i < preLoadSongs.length; i++) {
        saveSong(preLoadSongs[i].name, preLoadSongs[i].songNotes, 0)
    }
}

//--------------------------------------------------------------------------------------------------------//

function saveSong(songName, song, savingType) { //the name of the song, the array containing the key press and time stamp, if it has to be ignored or not for the save option
    let songObj = {
        name: songName,
        songNotes: song
    }
    if(savingType == "1") { //doesnt save if it is preloading   
        var songStorage = localStorage.getItem("savedSongs")
        if(songStorage != null) {
            songStorage = JSON.parse(songStorage)
            songStorage.push(songObj)
            localStorage.setItem("savedSongs", JSON.stringify(songStorage))
        }else{
            songStorage = [songObj]
            localStorage.setItem("savedSongs", JSON.stringify(songStorage))
        }
    }
    //--------------------------------// Dinamically create the button to play the song
    let songContainer = document.createElement("div")
    let songButton = document.createElement("button")
    songButton.setAttribute("songName", songName)
    songButton.addEventListener("click", function() {
        savedSongsDivWrapper.style.display = "none"
        let storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        resetButtons()
        playSong(JSON.parse(songText.innerHTML))
    })
    songButton.innerHTML = songName
    songButton.className = "skyButton"
    songButton.style.width = "calc(100% - 135px - 5em)"
    //--------------------------------// This holds the text of the array of the song 
    let songText = document.createElement("div")
    songText.style.display = "none"
    songText.id = "Song-" + songName
    songText.innerHTML = JSON.stringify(song)
    songContainer.appendChild(songButton)
    songContainer.appendChild(songText)
    console.log("song added!")

    let deleteButton = document.createElement("button")
        deleteButton.innerHTML = "âŒ"
        deleteButton.className = "skyButton"
        deleteButton.style.width = "40px"
        deleteButton.style.marginLeft = "0.1em"
        deleteButton.setAttribute("songName", songName)


        if(savingType == "2"){ //if its a song coming from the database, put the delete button also to delete it from the db
            songButton.style.width = "calc(100% - 95px - 5em)"
            deleteButton.innerHTML = "âŒ"
            dbSongsDiv.appendChild(songContainer)
            deleteButton.addEventListener("click", function() {
                if(confirm("Delete song: " + this.getAttribute("songName") + " from database?")) {
                    this.parentNode.parentNode.removeChild(this.parentNode)
                    deleteFromDB(globalCredentials,this.getAttribute("songName"))
                }
            })
    }else{
        savedSongsDiv.appendChild(songContainer)
            //--------------------------------// button to delete the song from the saved and to delete it from the menu
        deleteButton.addEventListener("click", function() {
            if(confirm("Delete song: " + this.getAttribute("songName") + "?")) {
                this.parentNode.parentNode.removeChild(this.parentNode)
                var savedSongs = localStorage.getItem("savedSongs")
                if(savedSongs != null) {
                    savedSongs = JSON.parse(savedSongs)
                    for (let i = 0; i < savedSongs.length; i++) { //reads trough all the elements of the localStorage and deletes the index of this song
                        if(savedSongs[i].name == this.getAttribute("songName")) {
                            savedSongs.splice(i, 1)
                            break
                        }
                    }
                    localStorage.setItem("savedSongs", JSON.stringify(savedSongs))
                }
            }
        })

        let saveToDb = document.createElement("button")
        saveToDb.innerHTML = "ðŸ’¾"
        saveToDb.className = "skyButton"
        saveToDb.style.marginLeft = "0.1em"
        saveToDb.style.width = "40px"
        saveToDb.setAttribute("songName", songName)
        saveToDb.addEventListener("click", function() {
            savedSongsDivWrapper.style.display = "none"
            let storedSongName = this.getAttribute("songName")
            songText = document.getElementById("Song-" + storedSongName)
            let songArrayToDB = []
            let songObj = {
                name: storedSongName,
                songNotes: JSON.parse(songText.innerHTML)
            }
            songArrayToDB.push(songObj)
            saveSongsToDB(globalCredentials,songArrayToDB)
        })
        songContainer.appendChild(saveToDb)
    }
    //--------------------------------// Button to play this song in practice mode
    let trainSong = document.createElement("button")
    trainSong.innerHTML = "ðŸŽ¯"
    trainSong.className = "skyButton"
    trainSong.style.width = "40px"
    trainSong.style.marginLeft = "0.1em"
    trainSong.setAttribute("songName", songName)
    trainSong.addEventListener("click", function() {
        savedSongsDivWrapper.style.display = "none"
        let storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        practice(JSON.parse(songText.innerHTML))
    })
    //--------------------------------// Button to share this song
    let shareButton = document.createElement("button")
    shareButton.innerHTML = "<img src='icons/share.png' alt='share' width='20px' style='vertical-align: bottom'/>"
    shareButton.style.color = "lightgreen"
    shareButton.style.fontWeight = "bold"
    shareButton.className = "skyButton"
    shareButton.style.width = "40px"
    shareButton.style.marginLeft = "0.1em"
    shareButton.setAttribute("songName", songName)
    shareButton.addEventListener("click", function() {
        let storedSongName = this.getAttribute("songName")
        songText = document.getElementById("Song-" + storedSongName)
        let songObj = {
            name: storedSongName,
            songNotes: JSON.parse(songText.innerHTML)
        }
        let array = []
        array.push(songObj)
        downloadJSON(array, storedSongName + ".json")
    })
    songContainer.appendChild(trainSong)
    songContainer.appendChild(deleteButton)
    songContainer.appendChild(shareButton)
}

//--------------------------------------------------------------------------------------------------------//

async function playSong(song) {
    let delayTime = 0
    let previousTime = 0
    usesTouch = false
    for (let i = 0; i < song.length; i++) {
        delayTime = song[i].time - previousTime //how much time has to pass from one note to the other
        previousTime = song[i].time //the time from the start of the previous note, to be later calculated to get the delayTime
        await delay(delayTime)
        document.getElementById(song[i].key).click()
    }
}


//--------------------------------------------------------------------------------------------------------//

function resetButtons() {
    for (let i = 0; i < numOfKeysLeft; i++) {
        let btnBg = document.getElementById("Key" + i).firstChild
        btnBg.style.backgroundColor = "rgba(22, 22, 22, 0.65)"
    }
}

//--------------------------------------------------------------------------------------------------------//

//Function to practice a song
let songToPractice = []
let keysToPress = []
let threshold = 50
let keysToWait = 1
let betweenKeysTimes = []
let timeToWait = 0
let nextKeysToPress = []
betweenKeysTimes.push(0) //offsets the first key
function practice(inSong) {
    if(inSong.length != 0) { //If there is a song to be added, if there isn't it means that it comes from a ping from the button
        //RESET OF VALUES AND SETTING UP THE SONG
        betweenKeysTimes = []
        betweenKeysTimes.push(0)
        timeToWait = 0
        songToPractice = inSong
        keysToWait = 1
        justReset = true
        resetButtons()
        for(let i=1; i<songToPractice.length;i++){ //stores the time between keys
            betweenKeysTimes.push(songToPractice[i].time - songToPractice[i-1].time)
        }
    }
    if(songToPractice.length == 0) return
    keysToWait--   
    if(keysToWait == 0) {
        keysToPress = []
        nextKeysToPress = []
        for (let i = 0; i < songToPractice.length; i++) {
            if((songToPractice[i].time - songToPractice[0].time) < threshold) { //if the time between the next keys is lower than the threshold then it appends to the keys to be played
                keysToPress.push(songToPractice[i])
            }
        }
        for(let i = keysToPress.length; i<songToPractice.length;i++) {
            if((songToPractice[i].time - songToPractice[keysToPress.length].time) < threshold) {
                nextKeysToPress.push(songToPractice[i])
            }
        }
        setTimeout(() => { //delays from the ping so that it lets the key change it's color 
            setTimeout(() => {
                for(let i = 0; i < nextKeysToPress.length;i++){
                     $("#"+nextKeysToPress[i].key).children(":first").animate({"border-color": '#1BB8E8'}, 220)
                }                 
            }, timeToWait - 320)
            let willBeEmpty = songToPractice.length - keysToPress.length
            betweenKeysTimes.splice(0,keysToPress.length) //removes the times of each button since they arent used
            for (let i = 0; i < keysToPress.length; i++) { //it changes the color to the reddish one and removes the keys to be pressed from the array
                $("#" + keysToPress[i].key).children(":first").cssborderColor = "transparent"
                $("#" + keysToPress[i].key).children(":first").css("border-color","transparent").animate({backgroundColor: 'rgba(235, 0, 27, 0.7)'}, timeToWait)
                songToPractice.splice(0, 1)   
            }
            timeToWait=betweenKeysTimes[0] - 220 //gets the first time of the array, that one is the time for the next one.
        }, 220)

        keysToWait = keysToPress.length //those are the keys presses to do before searching for the next key combination
    }
}
//--------------------------------------------------------------------------------------------------------//

//delay function
const delay = ms => new Promise(res => setTimeout(res, ms))

//--------------------------------------------------------------------------------------------------------//


let songArray = []
//Each time a button is pressed, if the record is toggled, it adds a timestamp and what button is pressed
function recordSong(pressedKey) {
    if(isRecordToggled) {
        pressTime = new Date().getTime()
        let keyPressObject = {
            time: pressTime - startTime,
            key: pressedKey
        }
        songArray.push(keyPressObject)
    }
}

//--------------------------------------------------------------------------------------------------------//

//show menu function
function showMenu() {
    resetForms()
    if (menuButton.style.display!="block") {
        menu.style.display="none"
        menuButton.style.display="block"
    }
    else{
        menu.style.display="block"
        menuButton.style.display="none"
    }
}


//--------------------------------------------------------------------------------------------------------//

var floatingMessage
function showMessage(msg,msgType) {
    floatingMessage = document.getElementById("floatingMessage")
    floatingMessage.innerHTML = msg
    var color 
    if(msgType == 0) color = "rgba(235, 0, 27, 0.8)" //ERROR
    if(msgType == 1) color = "lightgreen" //SUCCESS
    if(msgType == 2) color = "#dad8b3" //MESSAGE
    floatingMessage.style.color = color
    $(floatingMessage).fadeIn(300).delay(1500).fadeOut(300)
}
</script>